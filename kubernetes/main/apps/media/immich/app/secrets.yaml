---
# yaml-language-server: $schema=https://schemas.zinn.ca/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: immich
spec:
  refreshInterval: 12h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: immich-secret
    creationPolicy: Owner
    template:
      data:
        # Immich
        DB_URL: "postgres://{{ .DB_USERNAME }}:{{ .DB_PASSWORD }}@immich-rw.media.svc.cluster.local.:5432/immich"
        JWT_SECRET: "{{ .JWT_SECRET }}"
        # Postgres Init
        INIT_POSTGRES_DBNAME: immich
        INIT_POSTGRES_HOST: immich-rw.media.svc.cluster.local
        INIT_POSTGRES_USER: "{{ .DB_USERNAME }}"
        INIT_POSTGRES_PASS: "{{ .DB_PASSWORD }}"
        INIT_POSTGRES_USER_FLAGS: "-s"
        INIT_POSTGRES_SUPER_USER: "{{ .POSTGRES_SUPER_USER }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
        immich-config.yaml: |
          backup:
            database:
              enabled: true
              cronExpression: "0 02 * * *"
              keepLastAmount: 14

          ffmpeg:
            accel: qsv
            accelDecode: true
            acceptedAudioCodecs:
              - aac
              - mp3
              - libopus
            acceptedContainers:
              - mov
              - ogg
              - webm
            acceptedVideoCodecs:
              - hevc
              - h264
            bframes: -1
            cqMode: auto
            crf: 23
            gopSize: 0
            maxBitrate: "0"
            preset: veryslow
            refs: 0
            targetAudioCodec: aac
            targetResolution: "1080"
            targetVideoCodec: hevc
            temporalAQ: false
            threads: 0
            tonemap: "reinhard"
            transcode: required
            twoPass: false

          image:
            colorspace: p3
            extractEmbedded: false
            preview:
              format: jpeg
              quality: 80
              size: 1440
            thumbnail:
              format: webp
              quality: 80
              size: 250

          job:
            backgroundTask: { concurrency: 5 }
            faceDetection: { concurrency: 4 }
            library: { concurrency: 5 }
            metadataExtraction: { concurrency: 5 }
            migration: { concurrency: 10 }
            notifications: { concurrency: 5 }
            ocr: { concurrency: 3 }
            search: { concurrency: 10 }
            sidecar: { concurrency: 5 }
            smartSearch: { concurrency: 4 }
            thumbnailGeneration: { concurrency: 6 }
            videoConversion: { concurrency: 3 }

          library:
            scan:
              cronExpression: "0 0 * * *"
              enabled: true
            watch:
              enabled: false

          logging:
            enabled: true
            level: verbose

          machineLearning:
            enabled: true
            urls:
              - http://immich-machine-learning.media.svc.cluster.local:3003
            clip:
              enabled: true
              modelName: ViT-SO400M-16-SigLIP2-384__webli
            duplicateDetection:
              enabled: true
              maxDistance: 0.01
            facialRecognition:
              enabled: true
              maxDistance: 0.5
              minFaces: 3
              minScore: 0.7
              modelName: buffalo_l
            ocr:
              enabled: true
              maxResolution: 1280
              minDetectionScore: 0.4
              minRecognitionScore: 0.6
              modelName: EN__PP-OCRv5_mobile

          map:
            enabled: true

          newVersionCheck:
            enabled: false

          notifications:
            smtp:
              enabled: false

          oauth:
            enabled: false

          passwordLogin:
            enabled: true

          reverseGeocoding:
            enabled: true

          server:
            externalDomain: ""
            publicUsers: true
            loginPageMessage: Welcome to Immich

          storageTemplate:
            enabled: true
            hashVerificationEnabled: true
            template: {{ printf "%q" "{{album}}/{{y}}/{{MM}}/{{filename}}" }}

          trash:
            enabled: true
            days: 30

          user:
            deleteDelay: 7
  dataFrom:
    - extract:
        key: immich
    - extract:
        key: cloudnative-pg-superuser
