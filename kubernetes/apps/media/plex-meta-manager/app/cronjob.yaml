---
apiVersion: batch/v1
kind: CronJob
metadata:
  namespace: media
  name: plex-meta-manager
spec:
  suspend: false
  # Run once a day, every day, starting at 3AM
  schedule: "0 4 * * *"
  failedJobsHistoryLimit: 1
  successfulJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          initContainers:
            - name: copy-config
              image: ghcr.io/onedr0p/alpine:3.18.0@sha256:dd504f02473c176a0e68e4550ccaf6f6c0f14e9f64c08a59877f9c6153bf48a9
              command:
                - "/bin/sh"
                - "-c"
                - |
                  cd /config/env
                  for i in *; do
                    export $i="$(cat $i)"
                  done
                  cd /shared
                  cat /config/data/config.yaml | sed -e "s/ZZ_/$/" | envsubst > config.yaml
                  exit 0
              volumeMounts:
                - name: shared-config
                  mountPath: /shared
                - name: config-env
                  readOnly: true
                  mountPath: /config/env
                - name: config-data
                  readOnly: true
                  mountPath: /config/data
          containers:
            - name: plex-meta-manager
              image: meisnate12/plex-meta-manager:v1.19.0
              imagePullPolicy: IfNotPresent
              env:
                - name: PUID
                  value: "1000"
                - name: GUID
                  value: "1000"
                - name: TZ
                  value: "${CONFIG_TIMEZONE}"
                # - name: PMM_DEBUG
                - name: PMM_TEST
                  value: "false"
                - name: PMM_RUN
                  value: "true"
                # - name: PMM_COLLECTIONS
                - name: PMM_TIME
                  value: "14:00,05:18"
                - name: PMM_CONFIG
                  value: "/shared/config.yaml"
              volumeMounts:
                - name: media
                  mountPath: /media
                - name: shared-config
                  mountPath: /shared
              resources:
                requests:
                  memory: 500Mi
                  cpu: 100m
                limits:
                  memory: 2000Mi
                  cpu: 500m
          volumes:
            - name: media
              persistentVolumeClaim:
                claimName: media-datastore
            - name: shared-config
              emptyDir: {}
            - name: config-env
              secret:
                secretName: plex-meta-manager-secret
            - name: config-data
              configMap:
                name: plex-meta-manager-cm
