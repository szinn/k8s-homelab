---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2beta2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: bind
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.1.0
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
  values:
    controllers:
      main:
        annotations:
          secret.reloader.stakater.com/reload: bind-secret
          configmap.reloader.stakater.com/reload: bind-named-conf,bind-zones
        containers:
          main:
            image:
              repository: docker.io/internetsystemsconsortium/bind9
              tag: 9.19@sha256:5037e85fc032d16b494dff69a5b732735a1d5e8ffaf383d487421e057fd92d0d
            command:
              - /usr/sbin/named
            args:
              - "-4"
              - "-f"
              - "-c"
              - "/etc/bind/named.conf"
              - "-u"
              - "bind"

    service:
      main:
        controller: main
        type: LoadBalancer
        annotations:
          io.cilium/lb-ipam-ips: ${CONFIG_SVC_BIND_ADDR}
        ports:
          domain:
            port: 53
            protocol: UDP

    persistence:
      config:
        type: configMap
        name: bind-named-conf
        globalMounts:
          - path: /etc/bind/named.conf
            subPath: named.conf
            readOnly: true
      zones:
        type: configMap
        name: bind-zones
        globalMounts:
          - path: /etc/bind/zones
            readOnly: true
      cache:
        type: emptyDir
        globalMounts:
          - path: /var/cache/bind
      bind-keys:
        type: secret
        name: bind-secret
        globalMounts:
          - path: /etc/bind/rndc.key
            subPath: rndc
          - path: /etc/bind/externaldns.key
            subPath: externaldns
