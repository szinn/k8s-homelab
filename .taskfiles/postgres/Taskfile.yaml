---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  maintenance-main:
    desc: Set/unset maintenance mode on main cluster
    summary: |
      Args:
        command: 'set' or 'unset' (required)
    cmds:
      - kubectl cnpg --context main maintenance {{.command}} --reusePVC -n dbms postgres
      - kubectl cnpg --context main maintenance {{.command}} --reusePVC -n media immich
    requires:
      vars:
        - command

  maintenance-staging:
    desc: Set/unset maintenance mode on main cluster
    summary: |
      Args:
        command: 'set' or 'unset' (required)
    cmds:
      - kubectl cnpg --context staging maintenance {{.command}} --reusePVC -n dbms postgres
    requires:
      vars:
        - command

  down_authentik:
    desc: Turn down Authentik
    cmds:
      - task: _down
        vars:
          NAMESPACE: security
          HELMRELEASE: authentik
          KUSTOMIZATION: authentik
          SERVICES: deployment/authentik-server deployment/authentik-worker

  down_dmarc:
    desc: Turn down Dmarc Report
    cmds:
      - task: _down
        vars:
          NAMESPACE: self-hosted
          HELMRELEASE: dmarc-report
          KUSTOMIZATION: dmarc-report
          SERVICES: statefulset/dmarc-report

  down_lidarr:
    desc: Turn down Lidarr
    cmds:
      - task: _down
        vars:
          NAMESPACE: media
          HELMRELEASE: lidarr
          KUSTOMIZATION: lidarr
          SERVICES: deployment/lidarr

  down_prowlarr:
    desc: Turn down Prowlarr
    cmds:
      - task: _down
        vars:
          NAMESPACE: media
          HELMRELEASE: prowlarr
          KUSTOMIZATION: prowlarr
          SERVICES: deployment/prowlarr

  down_radarr-4k:
    desc: Turn down Radarr 4K
    cmds:
      - task: _down
        vars:
          NAMESPACE: media
          HELMRELEASE: radarr-4k
          KUSTOMIZATION: radarr-4k
          SERVICES: deployment/radarr-4k

  down_radarr:
    desc: Turn down Radarr
    cmds:
      - task: _down
        vars:
          NAMESPACE: media
          HELMRELEASE: radarr
          KUSTOMIZATION: radarr
          SERVICES: deployment/radarr

  down_shlink:
    desc: Turn down Shlink
    cmds:
      - task: _down
        vars:
          NAMESPACE: self-hosted
          HELMRELEASE: shlink-api
          KUSTOMIZATION: shlink
          SERVICES: deployment/shlink-api

  down_sonarr:
    desc: Turn down Sonarr
    cmds:
      - task: _down
        vars:
          NAMESPACE: media
          HELMRELEASE: sonarr
          KUSTOMIZATION: sonarr
          SERVICES: deployment/sonarr

  down_wikijs:
    desc: Turn down WikiJS
    cmds:
      - task: _down
        vars:
          NAMESPACE: self-hosted
          HELMRELEASE: wikijs
          KUSTOMIZATION: wikijs
          SERVICES: deployment/wikijs

  down_home-assistant:
    desc: Turn down Home Assistant
    cmds:
      - task: _down
        vars:
          NAMESPACE: home
          HELMRELEASE: home-assistant
          KUSTOMIZATION: home-assistant
          SERVICES: deployment/home-assistant

  down_gatus:
    desc: Turn down Gatus
    cmds:
      - task: _down
        vars:
          NAMESPACE: observability
          HELMRELEASE: gatus
          KUSTOMIZATION: gatus
          SERVICES: deployment/gatus

  down_grafana:
    desc: Turn down Grafana
    cmds:
      - task: _down
        vars:
          NAMESPACE: observability
          HELMRELEASE: grafana
          KUSTOMIZATION: grafana
          SERVICES: deployment/grafana

  down_immich:
    desc: Turn down Immich
    cmds:
      - task: _down
        vars:
          NAMESPACE: media
          HELMRELEASE: immich
          KUSTOMIZATION: immich
          SERVICES: deployment/immich-server

  down_all:
    desc: Turn down all applications using Postgres
    cmds:
      - task: down_authentik
      - task: down_dmarc
      - task: down_lidarr
      - task: down_prowlarr
      - task: down_radarr-4k
      - task: down_radarr
      - task: down_shlink
      - task: down_sonarr
      - task: down_wikijs
      - task: down_home-assistant
      - task: down_gatus
      - task: down_grafana

  up_authentik:
    desc: Turn up Authentik
    cmds:
      - task: _up
        vars:
          NAMESPACE: security
          HELMRELEASE: authentik
          KUSTOMIZATION: authentik
          SERVICES: deployment/authentik-server deployment/authentik-worker
          REPLICAS: 1

  up_dmarc:
    desc: Turn up Dmarc Report
    cmds:
      - task: _up
        vars:
          NAMESPACE: self-hosted
          HELMRELEASE: dmarc-report
          KUSTOMIZATION: dmarc-report
          SERVICES: statefulset/dmarc-report
          REPLICAS: 1

  up_lidarr:
    desc: Turn up Lidarr
    cmds:
      - task: _up
        vars:
          NAMESPACE: media
          HELMRELEASE: lidarr
          KUSTOMIZATION: lidarr
          SERVICES: deployment/lidarr
          REPLICAS: 1

  up_prowlarr:
    desc: Turn up Prowlarr
    cmds:
      - task: _up
        vars:
          NAMESPACE: media
          HELMRELEASE: prowlarr
          KUSTOMIZATION: prowlarr
          SERVICES: deployment/prowlarr
          REPLICAS: 1

  up_radarr-4k:
    desc: Turn up Radarr 4K
    cmds:
      - task: _up
        vars:
          NAMESPACE: media
          HELMRELEASE: radarr-4k
          KUSTOMIZATION: radarr-4k
          SERVICES: deployment/radarr-4k
          REPLICAS: 1

  up_radarr:
    desc: Turn up Radarr
    cmds:
      - task: _up
        vars:
          NAMESPACE: media
          HELMRELEASE: radarr
          KUSTOMIZATION: radarr
          SERVICES: deployment/radarr
          REPLICAS: 1

  up_shlink:
    desc: Turn up Shlink
    cmds:
      - task: _up
        vars:
          NAMESPACE: self-hosted
          HELMRELEASE: shlink-api
          KUSTOMIZATION: shlink
          SERVICES: deployment/shlink-api
          REPLICAS: 1

  up_sonarr:
    desc: Turn up Sonarr
    cmds:
      - task: _up
        vars:
          NAMESPACE: media
          HELMRELEASE: sonarr
          KUSTOMIZATION: sonarr
          SERVICES: deployment/sonarr
          REPLICAS: 1

  up_wikijs:
    desc: Turn up WikiJS
    cmds:
      - task: _up
        vars:
          NAMESPACE: self-hosted
          HELMRELEASE: wikijs
          KUSTOMIZATION: wikijs
          SERVICES: deployment/wikijs
          REPLICAS: 1

  up_home-assistant:
    desc: Turn up Home Assistant
    cmds:
      - task: _up
        vars:
          NAMESPACE: home
          HELMRELEASE: home-assistant
          KUSTOMIZATION: home-assistant
          SERVICES: deployment/home-assistant
          REPLICAS: 1

  up_gatus:
    desc: Turn up Gatus
    cmds:
      - task: _up
        vars:
          NAMESPACE: observability
          HELMRELEASE: gatus
          KUSTOMIZATION: gatus
          SERVICES: deployment/gatus
          REPLICAS: 1

  up_grafana:
    desc: Turn up Grafana
    cmds:
      - task: _up
        vars:
          NAMESPACE: observability
          HELMRELEASE: grafana
          KUSTOMIZATION: grafana
          SERVICES: deployment/grafana
          REPLICAS: 1

  up_immich:
    desc: Turn up Immich
    cmds:
      - task: _up
        vars:
          NAMESPACE: media
          HELMRELEASE: immich
          KUSTOMIZATION: immich
          SERVICES: deployment/immich-server
          REPLICAS: 1

  up_all:
    desc: Turn up all applications using Postgres
    cmds:
      - task: up_authentik
      - task: up_dmarc
      - task: up_lidarr
      - task: up_prowlarr
      - task: up_radarr-4k
      - task: up_radarr
      - task: up_shlink
      - task: up_sonarr
      - task: up_wikijs
      - task: up_home-assistant
      - task: up_gatus
      - task: up_grafana

  restore_authentik:
    desc: Restore authentik database
    cmds:
      - task: down_authentik
      - task: _restore_db
        vars:
          DATABASE: authentik
      - task: up_authentik

  restore_dmarc:
    desc: Restore dmarc database
    cmds:
      - task: down_dmarc
      - task: _restore_db
        vars:
          DATABASE: dmarc
      - task: up_dmarc

  restore_lidarr:
    desc: Restore lidarr database
    cmds:
      - task: down_lidarr
      - task: _restore_db
        vars:
          DATABASE: lidarr_main
      - task: up_lidarr

  restore_prowlarr:
    desc: Restore prowlarr database
    cmds:
      - task: down_prowlarr
      - task: _restore_db
        vars:
          DATABASE: prowlarr_main
      - task: up_prowlarr

  restore_radarr_4k:
    desc: Restore radarr-4k database
    cmds:
      - task: down_radarr-4k
      - task: _restore_db
        vars:
          DATABASE: radarr_4k_main
      - task: up_radarr-4k

  restore_radarr:
    desc: Restore radarr database
    cmds:
      - task: down_radarr
      - task: _restore_db
        vars:
          DATABASE: radarr_main
      - task: up_radarr

  restore_shlink:
    desc: Restore shlink database
    cmds:
      - task: down_shlink
      - task: _restore_db
        vars:
          DATABASE: shlink
      - task: up_shlink

  restore_sonarr:
    desc: Restore sonarr database
    cmds:
      - task: down_sonarr
      - task: _restore_db
        vars:
          DATABASE: sonarr_main
      - task: up_sonarr

  restore_wikijs:
    desc: Restore wikijs database
    cmds:
      - task: down_wikijs
      - task: _restore_db
        vars:
          DATABASE: wikijs
      - task: up_wikijs

  restore_immich:
    desc: Restore immich database
    cmds:
      - task: down_immich
      - cp {{.DBBACKUP}}/last/immich-latest.sql.gz /tmp
      - gzip -d /tmp/immich-latest.sql.gz
      - task: _restore_immich_db
      - rm /tmp/immich-latest.sql
      - task: up_immish

  _restore_immich_db:
    desc: Restore a database
    prompt: Ready to restore database immich?
    internal: true
    cmds:
      - cat /tmp/immich-latest.sql | sed "s/SELECT pg_catalog.set_config('search_path', '', false);/SELECT pg_catalog.set_config('search_path', 'public, pg_catalog', true);/g" | psql -h immich.zinn.ca

  _down:
    desc: Bring a service down
    internal: true
    cmds:
      - flux --context main suspend helmrelease -n {{.NAMESPACE}} {{.HELMRELEASE}}
      - flux --context main suspend kustomization {{.KUSTOMIZATION}}
      - for: { var: SERVICES }
        cmd: kubectl --context main scale --replicas=0 -n {{.NAMESPACE}} {{.ITEM}}

  _up:
    desc: Bring a service up
    internal: true
    cmds:
      - for: { var: SERVICES }
        cmd: kubectl --context main  scale --replicas={{.REPLICAS}} -n {{.NAMESPACE}} {{.ITEM}}
      - flux --context main  resume helmrelease -n {{.NAMESPACE}} {{.HELMRELEASE}}
      - flux --context main  resume kustomization {{.KUSTOMIZATION}}

  _restore_db:
    desc: Restore a database
    prompt: Ready to restore database {{.DATABASE}}?
    internal: true
    cmds:
      - cp {{.DBBACKUP}}/last/{{.DATABASE}}-latest.sql.gz /tmp
      - gzip -d /tmp/{{.DATABASE}}-latest.sql.gz
      - psql < /tmp/{{.DATABASE}}-latest.sql
      - rm /tmp/{{.DATABASE}}-latest.sql
